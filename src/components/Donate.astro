---
interface Props {
  etcAddress?: string;
  solAddress?: string;
}

const { etcAddress, solAddress } = Astro.props;
---

<div class="mt-8 mb-8 p-6 bg-slate-50 rounded-lg dark:bg-gray-900">
  <div class="flex flex-wrap gap-4 justify-center">
    {
      etcAddress && (
        <button
          class="donate-button-base etc-button"
          data-address={etcAddress}
          data-chain="etc"
          aria-label="使用小狐狸钱包捐赠 ETC"
        >
          <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
            <path d="M11.944 17.97L4.58 13.62 11.943 24l7.37-10.38-7.372 4.35h.003zM12.056 0L4.69 12.223l7.365 4.354 7.365-4.35L12.056 0z" />
          </svg>
          <span>捐赠 ETC</span>
        </button>
      )
    }

    {
      solAddress && (
        <button
          class="donate-button-base sol-button"
          data-address={solAddress}
          data-chain="sol"
          aria-label="使用 Phantom 钱包捐赠 SOL"
        >
          <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20.45 8.55a.65.65 0 0 0-.46-.19H4.73a.36.36 0 0 0-.29.55l3.63 4.88a.65.65 0 0 0 .46.19h15.26a.36.36 0 0 0 .29-.55zm-15.72 11a.65.65 0 0 0 .46.19h15.26a.36.36 0 0 0 .29-.55l-3.63-4.88a.65.65 0 0 0-.46-.19H4.39a.36.36 0 0 0-.29.55zM4.39 4.93h15.26a.65.65 0 0 0 .46-1.12L16.48.19a.65.65 0 0 0-.46-.19H4.73a.36.36 0 0 0-.29.55z" />
          </svg>
          <span>捐赠 SOL</span>
        </button>
      )
    }
  </div>

  <div
    id="donate-message"
    class="donate-message hidden mt-4 px-3 py-3 rounded-lg text-center text-sm"
  >
  </div>
</div>

<script>
  // 检查是否安装了 MetaMask
  function checkMetaMask(): boolean {
    return typeof window.ethereum !== "undefined";
  }

  // 检查是否安装了 Phantom (Solana 钱包)
  function checkPhantom(): boolean {
    return typeof window.solana !== "undefined" && window.solana.isPhantom;
  }

  // 显示消息
  function showMessage(message: string, type: "success" | "error" | "info") {
    const messageEl = document.getElementById("donate-message");
    if (messageEl) {
      messageEl.textContent = message;
      messageEl.className = `donate-message mt-4 px-3 py-3 rounded-lg text-center text-sm`;

      // 根据类型添加对应的样式
      if (type === "success") {
        messageEl.classList.add(
          "bg-green-100",
          "text-green-800",
          "dark:bg-green-900",
          "dark:text-green-200",
        );
      } else if (type === "error") {
        messageEl.classList.add(
          "bg-red-100",
          "text-red-800",
          "dark:bg-red-900",
          "dark:text-red-200",
        );
      } else if (type === "info") {
        messageEl.classList.add(
          "bg-blue-100",
          "text-blue-800",
          "dark:bg-blue-900",
          "dark:text-blue-200",
        );
      }

      setTimeout(() => {
        messageEl.className =
          "donate-message hidden mt-4 px-3 py-3 rounded-lg text-center text-sm";
      }, 5000);
    }
  }

  // 复制地址到剪贴板
  async function copyToClipboard(address: string): Promise<boolean> {
    try {
      await navigator.clipboard.writeText(address);
      return true;
    } catch (err) {
      console.error("复制失败:", err);
      return false;
    }
  }

  // 处理 ETC 捐赠
  async function handleETCDonate(address: string) {
    if (!checkMetaMask()) {
      const copied = await copyToClipboard(address);
      if (copied) {
        showMessage(
          `地址已复制: ${address.slice(0, 6)}...${address.slice(-4)} - 推荐安装 MetaMask 等 Web3 钱包以便捷转账`,
          "info",
        );
      } else {
        showMessage(
          `捐赠地址: ${address} - 推荐安装 Web3 钱包 (MetaMask 等)`,
          "info",
        );
      }
      return;
    }

    try {
      // 请求连接钱包
      await window.ethereum.request({ method: "eth_requestAccounts" });

      // 切换到 Ethereum Classic 网络 (chainId: 0x3d = 61)
      try {
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: "0x3d" }],
        });
      } catch (switchError: any) {
        // 如果网络不存在，尝试添加
        if (switchError.code === 4902) {
          await window.ethereum.request({
            method: "wallet_addEthereumChain",
            params: [
              {
                chainId: "0x3d",
                chainName: "Ethereum Classic",
                nativeCurrency: {
                  name: "Ethereum Classic",
                  symbol: "ETC",
                  decimals: 18,
                },
                rpcUrls: ["https://etc.rivet.link"],
                blockExplorerUrls: ["https://blockscout.com/etc/mainnet/"],
              },
            ],
          });
        } else {
          throw switchError;
        }
      }

      // 发起转账
      const transactionParameters = {
        to: address,
        from: window.ethereum.selectedAddress,
        value: "0x0", // 用户可以在 MetaMask 中修改金额
      };

      const txHash = await window.ethereum.request({
        method: "eth_sendTransaction",
        params: [transactionParameters],
      });

      showMessage("交易已发送！感谢您的捐赠 ❤️", "success");
    } catch (error: any) {
      console.error("ETC donation error:", error);
      if (error.code === 4001) {
        showMessage("您取消了交易", "info");
      } else {
        showMessage(`交易失败: ${error.message}`, "error");
      }
    }
  }

  // 处理 SOL 捐赠
  async function handleSOLDonate(address: string) {
    if (!checkPhantom()) {
      const copied = await copyToClipboard(address);
      if (copied) {
        showMessage(
          `地址已复制: ${address.slice(0, 6)}...${address.slice(-4)} - 推荐安装 Phantom 等 Web3 钱包以便捷转账`,
          "info",
        );
      } else {
        showMessage(
          `捐赠地址: ${address} - 推荐安装 Web3 钱包 (Phantom 等)`,
          "info",
        );
      }
      return;
    }

    try {
      // 连接钱包
      const resp = await window.solana.connect();
      showMessage("已连接钱包，请在 Phantom 中确认转账", "info");

      // 注意：这里只是连接钱包，实际转账需要使用 Solana web3.js
      // 由于这需要额外的依赖，这里提供简化版本
      // 实际使用时建议集成 @solana/web3.js

      // 简化版：直接打开 Phantom 的转账界面
      const solanaExplorerUrl = `https://phantom.app/ul/browse/https://phantom.app/ul/v1/send?recipient=${address}`;
      window.open(solanaExplorerUrl, "_blank");
    } catch (error: any) {
      console.error("SOL donation error:", error);
      if (error.code === 4001) {
        showMessage("您取消了连接", "info");
      } else {
        showMessage(`连接失败: ${error.message}`, "error");
      }
    }
  }

  // 绑定事件
  document.addEventListener("DOMContentLoaded", () => {
    const donateButtons = document.querySelectorAll(".donate-button-base");

    donateButtons.forEach((button) => {
      button.addEventListener("click", async (e) => {
        const target = e.currentTarget as HTMLElement;
        const address = target.dataset.address;
        const chain = target.dataset.chain;

        if (!address) return;

        if (chain === "etc") {
          await handleETCDonate(address);
        } else if (chain === "sol") {
          await handleSOLDonate(address);
        }
      });
    });
  });
</script>

<script is:inline>
  // 全局类型声明
  declare global {
    interface Window {
      ethereum?: any;
      solana?: any;
    }
  }
</script>
