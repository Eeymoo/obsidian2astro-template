---
import { SITE_TITLE } from "../consts";
import DarkModeButton from "./DarkModeButton.astro";
import HeaderLink from "./HeaderLink.astro";
import SearchBox from "./SearchBox.astro";
import Logo from "./Logo.astro";
import config from "../config";

interface Props {
  sticky?: boolean;
}

const { sticky = true } = Astro.props;
// Cast `navLinks` to any to avoid type errors in Astro templates when iterating
const navLinks: any = config.navLinks;
---

<header
  class={`bg-white dark:bg-slate-950 px-3 sm:px-4 py-3 transition-colors ${sticky ? "sticky top-0 z-50" : ""}`}
>
  <nav
    class="max-w-screen-xl mx-auto flex items-center justify-between gap-3 sm:gap-4 flex-wrap md:flex-nowrap lg:grid lg:grid-cols-[auto_1fr_auto] lg:items-center lg:gap-6"
  >
    <div class="flex items-center gap-3 flex-shrink-0">
      <!-- Mobile Menu Button (Left) -->
      <button
        id="mobile-menu-toggle"
        class="md:hidden flex items-center justify-center w-10 h-10 text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20 transition-colors"
        aria-label="Toggle menu"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="size-6"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z"
          ></path>
        </svg>
      </button>

      <!-- Logo (Center on mobile, left on desktop) -->
      <h2 class="no-style text-base m-0 logo">
        <a
          href="/"
          class="no-style underline decoration-primary hover:decoration-primary text-slate-900 dark:text-slate-50 transition-colors flex items-center justify-center md:justify-start"
        >
          <Logo class="inline-block w-6 h-6 mr-2" />
        </a>
      </h2>
    </div>

    <!-- Desktop Navigation -->
    <div
      class="hidden md:flex items-center justify-center gap-4 flex-wrap md:flex-1 md:min-w-0 lg:justify-center"
    >
      <div class="internal-links flex flex-wrap justify-center">
        {
          navLinks.map((link: any) => (
            <div class="relative group">
              {
                link.children ? (
                  <button class:list={[
                    "no-style inline-block px-2 mx-2 my-2 text-gray-700 dark:text-gray-300 underline hover:bg-primary/10 dark:hover:bg-primary/20 transition-colors rounded",
                    { "font-black text-gray-900 dark:text-gray-200! decoration-primary!": false },
                  ]} disabled={link.disabled}>
                    {link.name}
                  </button>
                ) : (
                  <HeaderLink href={link.href}>{link.name}</HeaderLink>
                )
              }

              {link.children ? (
                <div class="absolute left-0 mt-2 w-48 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all">
                  <div class="p-2">
                    {Array.isArray(link.children) && link.children.map((child: any) => (
                      <a href={child.href} class="block px-3 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-primary/10 rounded">{child.name}</a>
                    ))}
                  </div>
                </div>
              ) : null}
            </div>
          ))
        }
      </div>
    </div>

    <!-- Desktop Actions -->
    <div class="flex items-center gap-2 min-w-0 md:justify-end flex-shrink-0">
      <div class="hidden lg:block">
        <SearchBox />
      </div>
      <a
        href="/rss.xml"
        target="_blank"
        class="w-10 h-10 flex items-center justify-center text-slate-700 hover:bg-primary/10 transition-colors dark:text-slate-300 dark:hover:bg-primary/20"
      >
        <span class="sr-only">Subscribe to RSS</span>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="size-6"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M12.75 19.5v-.75a7.5 7.5 0 0 0-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z"
          ></path>
        </svg>
      </a>
      <DarkModeButton />
    </div>
  </nav>

  <!-- Mobile Menu -->
  <div
    id="mobile-menu"
    class="hidden md:hidden mt-4 pb-4 space-y-4 border-t border-slate-200 dark:border-slate-700 pt-4"
  >
    <SearchBox />
    <div class="internal-links flex flex-col gap-2">
      {
        navLinks.map((link: any) => (
          link.children ? (
            <div>
              <div class="px-3 py-2 text-slate-900 dark:text-slate-50 font-semibold">{link.name}</div>
              <div class="pl-4">
                {Array.isArray(link.children) && link.children.map((c: any) => (
                  <a href={c.href} class="block px-3 py-2 text-slate-900 dark:text-slate-50 hover:bg-primary/10 dark:hover:bg-primary/20 transition-colors">{c.name}</a>
                ))}
              </div>
            </div>
          ) : (
            <a
              href={link.href}
              class="block px-3 py-2 text-slate-900 dark:text-slate-50 hover:bg-primary/10 dark:hover:bg-primary/20 transition-colors"
            >
              {link.name}
            </a>
          )
        ))
      }
    </div>
  </div>
</header>

<script>
  const menuToggle = document.getElementById("mobile-menu-toggle");
  const mobileMenu = document.getElementById("mobile-menu");

  if (menuToggle && mobileMenu) {
    menuToggle.addEventListener("click", () => {
      mobileMenu.classList.toggle("hidden");
    });

    // Close menu when a link is clicked
    const links = mobileMenu.querySelectorAll("a");
    links.forEach((link) => {
      link.addEventListener("click", () => {
        mobileMenu.classList.add("hidden");
      });
    });
  }
</script>
