---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import { filterContent } from "../utils";

export interface Props {
  currentPost: CollectionEntry<"blog"> | {
    id: string;
    collection: "blog";
    data: any;
  };
  maxRelated?: number;
  strategy?: 'tags' | 'categories' | 'both';
}

const { currentPost, maxRelated = 6, strategy = 'both' } = Astro.props;

// 获取所有文章
const allPosts = filterContent(await getCollection("blog"));

// 计算相关度分数
function calculateRelatedScore(post1: CollectionEntry<"blog">, post2: CollectionEntry<"blog">): number {
  let score = 0;
  
  // 标签匹配（权重：2）
  if (strategy === 'tags' || strategy === 'both') {
    const tags1 = post1.data.tags || [];
    const tags2 = post2.data.tags || [];
    const commonTags = tags1.filter(tag => tags2.includes(tag));
    score += commonTags.length * 2;
  }
  
  // 分类匹配（权重：3）
  if (strategy === 'categories' || strategy === 'both') {
    const category1 = post1.data.categories;
    const category2 = post2.data.categories;
    if (category1 && category1 === category2) {
      score += 3;
    }
  }
  
  // 时间相近度（权重：1，越近越高）
  const date1 = post1.data.date instanceof Date ? post1.data.date : new Date(post1.data.date);
  const date2 = post2.data.date instanceof Date ? post2.data.date : new Date(post2.data.date);
  const timeDiff = Math.abs(date1.getTime() - date2.getTime());
  const daysDiff = timeDiff / (1000 * 60 * 60 * 24);
  if (daysDiff < 30) score += 1;
  else if (daysDiff < 90) score += 0.5;
  
  return score;
}

// 获取相关文章
function getRelatedPosts(
  currentPost: CollectionEntry<"blog">, 
  allPosts: CollectionEntry<"blog">[], 
  maxCount: number
): CollectionEntry<"blog">[] {
  // 排除当前文章和隐藏的文章
  const candidates = allPosts.filter(post => 
    post.id !== currentPost.id && 
    !post.data.hidden
  );
  
  // 计算相关度并排序
  const relatedPosts = candidates
    .map(post => ({
      post,
      score: calculateRelatedScore(currentPost, post)
    }))
    .filter(item => item.score > 0) // 只有关联度>0的文章
    .sort((a, b) => b.score - a.score)
    .slice(0, maxCount)
    .map(item => item.post);
  
  return relatedPosts;
}

const relatedPosts = getRelatedPosts(currentPost, allPosts, maxRelated);
---

{relatedPosts.length > 0 && (
  <section class="related-posts mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
      <svg class="inline-block w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
      </svg>
      相关文章
    </h2>
    
    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
      {relatedPosts.map((post) => {
        const tags = post.data.tags || [];
        const categories = post.data.categories;
        
        return (
          <article class="related-post-card bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden hover:shadow-lg transition-shadow duration-300">
            <a href={`/post/${post.data.uri || post.id.replace(/\.mdx?$/, '')}/`} class="block">
              {post.data.heroImage && (
                <div class="aspect-w-16 aspect-h-9 bg-gray-100 dark:bg-gray-700">
                  <img 
                    src={post.data.heroImage.src} 
                    alt=""
                    class="w-full h-48 object-cover"
                    loading="lazy"
                  />
                </div>
              )}
              
              <div class="p-4">
                <h3 class="font-semibold text-gray-900 dark:text-white mb-2 line-clamp-2 hover:text-primary-600 dark:hover:text-primary-400 transition-colors">
                  {post.data.title}
                </h3>
                
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3 line-clamp-2">
                  {post.data.description || ''}
                </p>
                
                <div class="flex flex-wrap items-center gap-2 text-xs text-gray-500 dark:text-gray-500">
                  <time datetime={post.data.date.toISOString()}>
                    {post.data.date.toLocaleDateString('zh-CN')}
                  </time>
                  
                  {categories && (
                    <>
                      <span class="text-gray-300 dark:text-gray-600">•</span>
                      <span class="text-primary-600 dark:text-primary-400">
                        {categories}
                      </span>
                    </>
                  )}
                  
                  {tags.length > 0 && (
                    <>
                      <span class="text-gray-300 dark:text-gray-600">•</span>
                      <span class="text-gray-600 dark:text-gray-400">
                        {tags.slice(0, 2).join(', ')}
                        {tags.length > 2 && '...'}
                      </span>
                    </>
                  )}
                </div>
              </div>
            </a>
          </article>
        );
      })}
    </div>
  </section>
)}

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .aspect-w-16 {
    position: relative;
    padding-bottom: calc(9 / 16 * 100%);
  }
  
  .aspect-w-16 img {
    position: absolute;
    height: 100%;
    width: 100%;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
  }
</style>