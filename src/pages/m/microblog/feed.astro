---
import { getCollection, render } from "astro:content";
import MobileMicroblogLayout from "../../../layouts/MobileMicroblogLayout.astro";
import { filterContent } from "../../../utils";

// è·å–æ‰€æœ‰å¾®åšç”¨äºæ— é™æ»šåŠ¨
const allPosts = filterContent(await getCollection("blog"), 'microblog')
  .sort((a, b) => b.data.date?.valueOf() - a.data.date?.valueOf());

// é¦–æ¬¡åŠ è½½50æ¡ï¼Œåç»­é€šè¿‡APIåŠ è½½
const initialPosts = allPosts.slice(0, 50);

const posts = await Promise.all(
  initialPosts.map(async (post) => ({
    ...post,
    html: await render(post),
  }))
);
---

<MobileMicroblogLayout 
  title="å¾®åš - æ— é™æ»šåŠ¨" 
  posts={posts}
  showLoadMore={true}
  enablePullRefresh={true}
/>

<!-- æ·»åŠ æ— é™æ»šåŠ¨è„šæœ¬ -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    let currentPage = 1;
    let isLoading = false;
    let hasMoreContent = true;
    
    const microblogMain = document.querySelector('.mobile-microblog-main');
    const loadMoreBtn = document.querySelector('.load-more-btn');
    const loadingSpinner = document.querySelector('.loading-spinner');
    const microblogList = document.querySelector('.microblog-list');
    
    // æ¨¡æ‹ŸåŠ è½½æ›´å¤šå†…å®¹ï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¯¥è°ƒç”¨APIï¼‰
    async function loadMorePosts() {
      if (isLoading || !hasMoreContent) return;
      
      isLoading = true;
      loadMoreBtn.classList.add('hidden');
      loadingSpinner.classList.remove('hidden');
      
      try {
        // æ¨¡æ‹ŸAPIå»¶è¿Ÿ
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // è¿™é‡Œåº”è¯¥è°ƒç”¨å®é™…çš„APIè·å–æ›´å¤šå†…å®¹
        // const response = await fetch(`/api/microblog?page=${currentPage + 1}`);
        // const newPosts = await response.json();
        
        // æ¨¡æ‹Ÿæ²¡æœ‰æ›´å¤šå†…å®¹
        if (currentPage >= 3) {
          hasMoreContent = false;
          loadingSpinner.textContent = 'å·²åŠ è½½å…¨éƒ¨å†…å®¹';
          return;
        }
        
        // æ¨¡æ‹ŸåŠ è½½çš„æ–°å†…å®¹
        const newPostHTML = `
          <article class="microblog-post loaded-item">
            <div class="post-header">
              <time class="post-time">12æœˆ${20 + currentPage}æ—¥ 14:${30 + currentPage}</time>
              <span class="ai-tag">AI</span>
            </div>
            <div class="post-content">
              <div class="content-text">
                è¿™æ˜¯åŠ¨æ€åŠ è½½çš„å¾®åšå†…å®¹ ${currentPage + 1}...
              </div>
            </div>
            <div class="post-actions">
              <button class="action-btn share-btn" data-title="åŠ¨æ€å¾®åš">
                <span class="icon">ğŸ“¤</span>
                <span class="text">åˆ†äº«</span>
              </button>
              <button class="action-btn more-btn">
                <span class="icon">â‹¯</span>
              </button>
            </div>
          </article>
        `;
        
        microblogList.insertAdjacentHTML('beforeend', newPostHTML);
        
        currentPage++;
        
      } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        loadingSpinner.textContent = 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•';
      } finally {
        isLoading = false;
        loadingSpinner.classList.add('hidden');
        
        if (hasMoreContent) {
          loadMoreBtn.classList.remove('hidden');
        }
      }
    }
    
    // ç‚¹å‡»åŠ è½½æ›´å¤š
    loadMoreBtn?.addEventListener('click', loadMorePosts);
    
    // æ»šåŠ¨åˆ°åº•éƒ¨è‡ªåŠ¨åŠ è½½
    let scrollTimeout;
    microblogMain?.addEventListener('scroll', () => {
      clearTimeout(scrollTimeout);
      
      scrollTimeout = setTimeout(() => {
        if (!isLoading && hasMoreContent) {
          const { scrollTop, scrollHeight, clientHeight } = microblogMain;
          const threshold = 100; // è·ç¦»åº•éƒ¨100pxæ—¶è§¦å‘
          
          if (scrollTop + clientHeight >= scrollHeight - threshold) {
            loadMorePosts();
          }
        }
      }, 100);
    });
    
    // ä¸ºåŠ¨æ€åŠ è½½çš„å…ƒç´ æ·»åŠ äº‹ä»¶ç›‘å¬
    document.addEventListener('click', (e) => {
      const shareBtn = e.target.closest('.share-btn');
      if (shareBtn) {
        e.preventDefault();
        const title = shareBtn.dataset.title;
        const url = window.location.href;
        
        if (navigator.share) {
          navigator.share({ title, url });
        } else {
          navigator.clipboard.writeText(`${title} - ${url}`);
          showToast('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }
      }
    });
  });
</script>

<style>
  .loaded-item {
    animation: fadeIn 0.3s ease-in;
  }
  
  @keyframes fadeIn {
    from { 
      opacity: 0; 
      transform: translateY(20px); 
    }
    to { 
      opacity: 1; 
      transform: translateY(0); 
    }
  }
</style>