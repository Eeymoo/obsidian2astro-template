---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';
import '../../styles/global.css';
---

<!doctype html>
<html lang="zh-CN" class="scroll-smooth">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
    <script>
      // é˜²æ­¢é—ªçƒï¼šåœ¨é¡µé¢åŠ è½½å‰è®¾ç½®ä¸»é¢˜
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const isDark = savedTheme === 'dark' || (!savedTheme && prefersDark);
      if (isDark) {
        document.documentElement.classList.add('dark');
      }
    </script>
  </head>
  <body>
    <Header />
    <main class="w-full max-w-2xl mx-auto px-4 py-16 min-h-screen flex flex-col justify-center">
      <!-- å€’è®¡æ—¶åŒºåŸŸ - é«˜ä¼˜å…ˆçº§å±•ç¤º -->
      <div id="countdownContainer" class="mb-12">
        <div class="text-center">
          <div class="inline-flex items-center justify-center w-40 h-40 rounded-full bg-gradient-to-br from-primary via-primary/80 to-primary/60 shadow-lg mb-6">
            <span id="countdown" class="text-8xl font-bold text-white drop-shadow-md">3</span>
          </div>
          <p class="text-2xl font-semibold text-gray-900 dark:text-white mt-4">ç§’åè·³è½¬</p>
        </div>
      </div>

      <!-- URL å±•ç¤ºåŒºåŸŸ - çªå‡º -->
      <div id="urlDisplayContainer" class="mb-8 p-6 bg-primary/5 dark:bg-primary/10 border-2 border-primary/30 dark:border-primary/40 rounded-lg">
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">ç›®æ ‡ç½‘å€</p>
        <p id="urlDisplay" class="text-lg md:text-xl font-semibold text-primary break-all leading-relaxed">
          è·å–ä¸­...
        </p>
      </div>

      <!-- URL è¾“å…¥åŒºåŸŸ -->
      <div id="urlInputContainer" class="hidden mb-8">
        <p class="text-2xl font-bold text-center mb-6 text-gray-900 dark:text-white">è¾“å…¥è¦è·³è½¬çš„åœ°å€</p>
        <div class="mb-6">
          <input 
            id="urlInput" 
            type="text" 
            placeholder="ä¾‹å¦‚: https://github.com æˆ– steam://app/730 æˆ–ä»»æ„ xxx:xxx"
            class="w-full px-4 py-3 text-lg border-2 border-primary/30 dark:border-primary/40 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
          />
        </div>

        <!-- é€‰é¡¹å¤é€‰æ¡† -->
        <div class="mb-8 space-y-3">
          <label class="flex items-center gap-3 cursor-pointer">
            <input 
              id="stopOption" 
              type="checkbox" 
              class="w-5 h-5 accent-primary"
            />
            <span class="text-gray-700 dark:text-gray-300">ä¸è‡ªåŠ¨è·³è½¬ (stop=true)</span>
          </label>
          <label class="flex items-center gap-3 cursor-pointer">
            <input 
              id="isNewOption" 
              type="checkbox" 
              class="w-5 h-5 accent-primary"
            />
            <span class="text-gray-700 dark:text-gray-300">ç«‹å³è·³è½¬ (isNew=true)</span>
          </label>
        </div>
      </div>

      <!-- é¡µé¢æ ‡é¢˜ -->
      <h1 id="pageTitle" class="text-4xl md:text-5xl font-bold text-center mb-6 text-gray-900 dark:text-white">
        ğŸŒ é‡å®šå‘ä¸­
      </h1>

      <!-- æè¿°æ–‡æœ¬ -->
      <p id="pageDescription" class="text-center text-gray-700 dark:text-gray-300 mb-8 text-base md:text-lg">
        æ­£åœ¨ä¸ºæ‚¨è·³è½¬åˆ°ç›®æ ‡é¡µé¢ï¼Œè¯·ç¨ç­‰...
      </p>

      <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
      <div id="redirectButtonsContainer" class="flex flex-col sm:flex-row gap-8 justify-center items-center mt-8">
        <!-- ç«‹å³è·³è½¬é“¾æ¥ -->
        <a 
          id="redirectLink" 
          href="#" 
          class="no-style px-16 py-4 bg-primary text-white font-bold text-lg rounded-full hover:bg-primary/90 active:scale-95 transition-all duration-200 shadow-lg hover:shadow-xl"
        >
          ç«‹å³è·³è½¬
        </a>

        <!-- å–æ¶ˆé“¾æ¥ -->
        <a
          id="cancelBtn"
          href="#"
          class="no-style px-16 py-4 bg-gray-300 dark:bg-gray-600 text-gray-900 dark:text-white font-bold text-lg rounded-full hover:bg-gray-400 dark:hover:bg-gray-500 active:scale-95 transition-all duration-200 shadow-md hover:shadow-lg"
        >
          å–æ¶ˆ
        </a>
      </div>

      <!-- è¾“å…¥æ¨¡å¼æŒ‰é’® -->
      <div id="inputButtonsContainer" class="hidden flex flex-col sm:flex-row gap-8 justify-center items-center mt-8">
        <!-- æäº¤æŒ‰é’® -->
        <a 
          id="submitBtn" 
          href="#" 
          class="no-style px-16 py-4 bg-primary text-white font-bold text-lg rounded-full hover:bg-primary/90 active:scale-95 transition-all duration-200 shadow-lg hover:shadow-xl"
        >
          ç¡®è®¤è·³è½¬
        </a>

        <!-- å¤åˆ¶é“¾æ¥æŒ‰é’® -->
        <a
          id="copyBtn"
          href="#"
          class="no-style px-16 py-4 bg-gray-300 dark:bg-gray-600 text-gray-900 dark:text-white font-bold text-lg rounded-full hover:bg-gray-400 dark:hover:bg-gray-500 active:scale-95 transition-all duration-200 shadow-md hover:shadow-lg"
        >
          å¤åˆ¶é“¾æ¥
        </a>
      </div>

      <!-- å¤‡æ³¨ä¿¡æ¯ -->
      <p id="footerNote" class="text-center text-xs text-gray-500 dark:text-gray-400 mt-12">
        å¦‚æœé¡µé¢æœªèƒ½è‡ªåŠ¨è·³è½¬ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹"ç«‹å³è·³è½¬"æŒ‰é’®
      </p>
    </main>
    <Footer />

    <script>
      // è·å– URL å‚æ•°
      const urlParams = new URLSearchParams(window.location.search);
      const url = urlParams.get('url') || '';
      const stop = urlParams.get('stop') === 'true';
      const isNew = urlParams.get('isNew') === 'true';
      
      // DOM å…ƒç´ 
      const urlDisplayContainer = document.getElementById('urlDisplayContainer');
      const urlInputContainer = document.getElementById('urlInputContainer');
      const redirectButtonsContainer = document.getElementById('redirectButtonsContainer');
      const inputButtonsContainer = document.getElementById('inputButtonsContainer');
      const pageTitle = document.getElementById('pageTitle');
      const pageDescription = document.getElementById('pageDescription');
      const footerNote = document.getElementById('footerNote');
      const countdownContainer = document.getElementById('countdownContainer');
      
      // å¦‚æœæ²¡æœ‰ url å‚æ•°ï¼Œæ˜¾ç¤ºè¾“å…¥æ¡†
      if (!url) {
        showInputMode();
      } else {
        showRedirectMode(url, stop, isNew);
      }
      
      function showInputMode() {
        // éšè—é‡å®šå‘ç›¸å…³çš„ UI
        if (urlDisplayContainer) urlDisplayContainer.classList.add('hidden');
        if (countdownContainer) countdownContainer.classList.add('hidden');
        if (redirectButtonsContainer) redirectButtonsContainer.classList.add('hidden');
        
        // æ˜¾ç¤ºè¾“å…¥ç›¸å…³çš„ UI
        if (urlInputContainer) urlInputContainer.classList.remove('hidden');
        if (inputButtonsContainer) inputButtonsContainer.classList.remove('hidden');
        
        // æ›´æ–°æ–‡æœ¬
        if (pageTitle) pageTitle.textContent = 'ğŸ”— URL é‡å®šå‘å·¥å…·';
        if (pageDescription) pageDescription.textContent = 'è¾“å…¥ä»»ä½• URL æˆ–è‡ªå®šä¹‰åè®®åœ°å€è¿›è¡Œè·³è½¬';
        if (footerNote) footerNote.textContent = 'æ”¯æŒæ‰€æœ‰ URI åè®®ï¼Œå¦‚ http://, https://, steam://, csgo:// ç­‰';
        
        // è¾“å…¥æ¡†å’Œé€‰é¡¹
        const urlInput = document.getElementById('urlInput');
        const stopOption = document.getElementById('stopOption');
        const isNewOption = document.getElementById('isNewOption');
        const submitBtn = document.getElementById('submitBtn');
        const copyBtn = document.getElementById('copyBtn');
        
        // æäº¤æŒ‰é’®
        submitBtn.addEventListener('click', (e) => {
          e.preventDefault();
          const inputUrl = urlInput.value.trim();
          if (inputUrl) {
            const params = new URLSearchParams({ url: inputUrl });
            if (stopOption.checked) params.append('stop', 'true');
            if (isNewOption.checked) params.append('isNew', 'true');
            window.location.href = `/goto?${params.toString()}`;
          }
        });
        
        // å¤åˆ¶é“¾æ¥æŒ‰é’®
        copyBtn.addEventListener('click', (e) => {
          e.preventDefault();
          const inputUrl = urlInput.value.trim();
          if (inputUrl) {
            const params = new URLSearchParams({ url: inputUrl });
            if (stopOption.checked) params.append('stop', 'true');
            if (isNewOption.checked) params.append('isNew', 'true');
            const fullLink = `${window.location.origin}/goto?${params.toString()}`;
            
            navigator.clipboard.writeText(fullLink).then(() => {
              const originalText = copyBtn.textContent;
              copyBtn.textContent = 'å·²å¤åˆ¶!';
              setTimeout(() => {
                copyBtn.textContent = originalText;
              }, 2000);
            });
          }
        });
        
        // å›è½¦æäº¤
        urlInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            submitBtn.click();
          }
        });
        
        // è‡ªåŠ¨èšç„¦
        urlInput.focus();
      }
      
      function showRedirectMode(targetUrl, shouldStop, shouldRedirectImmediately) {
        // è®¾ç½® URL æ˜¾ç¤ºå’Œé“¾æ¥
        const urlDisplay = document.getElementById('urlDisplay');
        const redirectLink = document.getElementById('redirectLink');
        
        if (urlDisplay) {
          urlDisplay.textContent = targetUrl;
        }
        if (redirectLink) {
          redirectLink.href = targetUrl;
        }
        
        // å¦‚æœ isNew=trueï¼Œç«‹å³è·³è½¬ï¼ˆä¸ç­‰å¾…å€’è®¡æ—¶ï¼‰
        if (shouldRedirectImmediately) {
          window.location.href = targetUrl;
        } else {
          // å€’è®¡æ—¶å’Œè·³è½¬é€»è¾‘ - é»˜è®¤ 3 ç§’åè·³è½¬
          let countdown = 3;
          const countdownEl = document.getElementById('countdown');
          const cancelBtn = document.getElementById('cancelBtn');
          let redirectTimer = null;
          
          function startCountdown() {
            redirectTimer = setInterval(() => {
              countdown--;
              if (countdownEl) {
                countdownEl.textContent = countdown.toString();
              }
              
              if (countdown <= 0) {
                if (redirectTimer) clearInterval(redirectTimer);
                window.location.href = targetUrl;
              }
            }, 1000);
          }
          
          if (cancelBtn) {
            cancelBtn.addEventListener('click', (e) => {
              e.preventDefault();
              if (redirectTimer) clearInterval(redirectTimer);
              cancelBtn.textContent = 'å·²å–æ¶ˆ';
              cancelBtn.classList.add('pointer-events-none', 'opacity-50');
              if (countdownEl) {
                countdownEl.classList.add('text-gray-400', 'dark:text-slate-500');
                countdownEl.textContent = 'å·²å–æ¶ˆ';
              }
            });
          }
          
          // å¦‚æœ stop=trueï¼Œä¸è‡ªåŠ¨è·³è½¬ï¼ˆåªæ˜¾ç¤ºé“¾æ¥ï¼‰
          if (!shouldStop) {
            startCountdown();
          } else {
            // stop=true æ—¶éšè—å€’è®¡æ—¶å®¹å™¨
            if (countdownContainer) {
              countdownContainer.style.display = 'none';
            }
          }
        }
      }
    </script>
  </body>
</html>

