---
import { type CollectionEntry, getCollection } from "astro:content";
import BaseHead from "../../../components/BaseHead.astro";
import Footer from "../../../components/Footer.astro";
import Header from "../../../components/Header.astro";
import PostDate from "../../../components/PostDate.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "../../../consts";
import { generatePostSlug } from "../../../utils";
import { generateTagSlug } from "../../../utils";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  const visible = posts.filter((p) => !p.data.hidden);

  const tagSet = new Set<string>();
  for (const post of visible) {
    for (const tag of post.data.tags || []) {
      tagSet.add(tag);
    }
  }

  return Array.from(tagSet).map((t) => ({
    params: { tag: generateTagSlug(t) },
    props: {},
  }));
}

const rawParam = Astro.params.tag ?? "";
const rawSlug = rawParam.replace(/\.html$/, "");

// 找到与当前 slug 对应的原始标签名
const allVisible = await getCollection("blog");
const tagSet = new Set<string>();
for (const post of allVisible.filter((p) => !p.data.hidden)) {
  for (const t of post.data.tags || []) tagSet.add(t);
}
const tag =
  Array.from(tagSet).find((t) => generateTagSlug(t) === rawSlug) ?? rawSlug;

const allPosts = (await getCollection("blog"))
  .filter((p) => !p.data.hidden)
  .filter((p) => (p.data.tags || []).includes(tag))
  .sort((a, b) => b.data.date?.valueOf() - a.data.date?.valueOf());
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <BaseHead title={`${SITE_TITLE} · ${tag}`} description={SITE_DESCRIPTION} />
    <script>
      const savedTheme = localStorage.getItem("theme");
      const prefersDark = window.matchMedia(
        "(prefers-color-scheme: dark)",
      ).matches;
      const isDark = savedTheme === "dark" || (!savedTheme && prefersDark);
      if (isDark) {
        document.documentElement.classList.add("dark");
      }
    </script>
  </head>
  <body>
    <Header />
    <main class="w-full max-w-285 mx-auto px-4 py-12">
      <section>
        <h1 class="m-0 mb-6 text-xl font-bold text-gray-900 dark:text-gray-100">
          标签：{tag}
        </h1>
        {
          allPosts.length === 0 ? (
            <p class="text-gray-600 dark:text-gray-300">该标签暂无文章。</p>
          ) : (
            <ul class="grid grid-cols-2 gap-6 list-none m-0 p-0 sm:grid-cols-1 sm:gap-6">
              {allPosts.map((post) => {
                const slug = generatePostSlug(post);
                return (
                  <li class="w-full first:mb-4">
                    <a
                      href={`/post/${slug}.html`}
                      class="block hover:bg-primary/20 p-4! rounded transition-colors"
                    >
                      <h4 class="title m-0 text-gray-900 leading-tight underline decoration-primary hover:decoration-primary transition-colors dark:text-gray-100">
                        {post.data.title}
                      </h4>
                      <PostDate
                        date={post.data.date}
                        updated={post.data.updated}
                      />
                    </a>
                  </li>
                );
              })}
            </ul>
          )
        }
      </section>
    </main>
    <Footer />
  </body>
</html>
