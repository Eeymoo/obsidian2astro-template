---
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import BaseHead from "../../components/BaseHead.astro";
import Footer from "../../components/Footer.astro";
import Header from "../../components/Header.astro";
import PostDate from "../../components/PostDate.astro";
import Tags from "../../components/Tags.astro";
import Categories from "../../components/Categories.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "../../consts";
import { generatePostSlug, filterContent } from "../../utils";

const posts = filterContent(await getCollection("blog"))
  .sort((a, b) => b.data.date?.valueOf() - a.data.date?.valueOf());
const image = {
  width: 1140,
  height: 360,
};

// Speculation Rules: prerender recent posts and related pages for faster navigation
const speculationUrls = [
  "/",              // Home page
  "/categories",    // Categories listing
  "/tags",          // Tags listing
  "/archives",      // Archives page
];
// Add URLs for the first few posts
posts.slice(0, 5).forEach((post) => {
  const slug = generatePostSlug(post);
  speculationUrls.push(`/post/${slug}.html`);
});
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} speculationUrls={speculationUrls} speculationEagerness="moderate" />
    <script>
      // 防止闪烁：在页面加载前设置主题
      const savedTheme = localStorage.getItem("theme");
      const prefersDark = window.matchMedia(
        "(prefers-color-scheme: dark)",
      ).matches;
      const isDark = savedTheme === "dark" || (!savedTheme && prefersDark);
      if (isDark) {
        document.documentElement.classList.add("dark");
      }
    </script>
  </head>
  <body>
    <Header />
    <main class="w-full max-w-285 mx-auto px-4 py-12">
      <section>
        <ul
          class="grid grid-cols-2 gap-6 list-none m-0 p-0 sm:grid-cols-1 sm:gap-6"
        >
          {
            posts.map((post) => {
              const uri = post.data.uri;
              const slug = generatePostSlug(post);
              if (!uri) {
                console.warn(`Post with id ${post.id} is missing 'uri' field.`);
              }
              return (
                <li class="w-full first:mb-4">
                  <a
                    data-uri={uri}
                    href={`/post/${slug}.html`}
                    class="no-style block hover:bg-primary/20 p-4 rounded transition-colors"
                  >
                    {post.data.heroImage && (
                      <Image
                        width={image.width}
                        height={image.height}
                        src={post.data.heroImage}
                        alt=""
                        class="mb-3 rounded-xl"
                      />
                    )}
                    <h4 class="title m-0 text-gray-900 leading-tight underline decoration-primary hover:decoration-primary transition-colors dark:text-gray-100">
                      {post.data.title}
                    </h4>
                    <div class="flex">
                      <PostDate
                        date={post.data.date}
                        updated={post.data.updated}
                      />
                      <Categories categories={post.data.categories} />
                    </div>
                    <Tags tags={post.data.tags} />
                  </a>
                </li>
              );
            })
          }
        </ul>
      </section>
    </main>
    <Footer />
  </body>
</html>
