---
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import BaseHead from "../../components/BaseHead.astro";
import Footer from "../../components/Footer.astro";
import FormattedDate from "../../components/FormattedDate.astro";
import Header from "../../components/Header.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "../../consts";
import crypto from "crypto";
import dayjs from "dayjs";

const posts = (await getCollection("blog"))
  .sort((a, b) => b.data.date?.valueOf() - a.data.date?.valueOf())
  .filter((post) => !post.data.hidden);
const image = {
  width: 1140,
  height: 360,
};
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
  </head>
  <body>
    <Header />
    <main class="w-full max-w-[1140px] mx-auto px-4 py-12">
      <section>
        <ul
          class="grid grid-cols-2 gap-4 list-none m-0 p-0 sm:grid-cols-1 sm:gap-2"
        >
          {
            posts.map((post) => {
              const uri = post.data.uri;
              const algorithm = "sha256";
              const id = crypto
                .createHash(algorithm)
                .update(post.id, "utf8")
                .digest("hex")
                .slice(0, 32);
              if (!uri) {
                console.warn(`Post with id ${post.id} is missing 'uri' field.`);
              }
              return (
                <li class="w-full first:mb-4">
                  <a
                    data-uri={uri}
                    href={`/post/${uri || id}.html`}
                    class="block hover:bg-primary/20 p-4 rounded transition-colors"
                  >
                    {
                      <Image
                        width={image.width}
                        height={image.height}
                        src={
                          post.data.heroImage ||
                          `https://picsum.photos/${image.width}/${image.height}/?beauty&random=${id}`
                        }
                        alt=""
                        class="mb-3 rounded-xl"
                      />
                    }
                    <h4 class="title m-0 text-gray-900 leading-tight underline decoration-secondary hover:decoration-primary transition-colors">
                      {post.data.title}
                    </h4>
                    <p class="date m-0 text-gray-400">
                      <FormattedDate date={post.data.date} />
                      {!dayjs(post.data.date).isSame(
                        dayjs(post.data.updated),
                        "day"
                      ) && (
                        <span class="ml-2">
                          Last updated on
                          <FormattedDate date={post.data.updated} />
                        </span>
                      )}
                    </p>
                    <ul class="flex gap-1">
                      {post.data.tags?.map((tag) => (
                        <li>
                          <span class="inline-block bg-secondary/20 text-primary text-sm px-2 py-1 rounded mr-2">
                            {tag}
                          </span>
                        </li>
                      ))}
                    </ul>
                    <ul class="flex gap-1">
                      {post.data.categories?.map((category) => (
                        <li>
                          <span class="inline-block bg-secondary/20 text-primary text-sm px-2 py-1 rounded mr-2">
                            {category}
                          </span>
                        </li>
                      ))}
                    </ul>
                  </a>
                </li>
              );
            })
          }
        </ul>
      </section>
    </main>
    <Footer />
  </body>
</html>
