---
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import BaseHead from "../../components/BaseHead.astro";
import Footer from "../../components/Footer.astro";
import FormattedDate from "../../components/FormattedDate.astro";
import Header from "../../components/Header.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "../../consts";
import crypto from "crypto";
import dayjs from "dayjs";

const posts = (await getCollection("blog"))
  .sort((a, b) => b.data.date?.valueOf() - a.data.date?.valueOf())
  .filter((post) => !post.data.hidden);
const image = {
  width: 1140,
  height: 360,
};
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
    <script>
      // 防止闪烁：在页面加载前设置主题
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const isDark = savedTheme === 'dark' || (!savedTheme && prefersDark);
      if (isDark) {
        document.documentElement.classList.add('dark');
      }
    </script>
  </head>
  <body>
    <Header />
    <main class="w-full max-w-[1140px] mx-auto px-4 py-12">
      <section>
        <ul
          class="grid grid-cols-2 gap-4 list-none m-0 p-0 sm:grid-cols-1 sm:gap-2"
        >
          {
            posts.map((post) => {
              const uri = post.data.uri;
              const algorithm = "sha256";
              const id = crypto
                .createHash(algorithm)
                .update(post.id, "utf8")
                .digest("hex")
                .slice(0, 32);
              if (!uri) {
                console.warn(`Post with id ${post.id} is missing 'uri' field.`);
              }
              return (
                <li class="w-full first:mb-4">
                  <a
                    data-uri={uri}
                    href={`/post/${uri || id}.html`}
                    class="block hover:bg-primary/20 p-4 rounded transition-colors"
                  >
                    {post.data.heroImage && (
                      <Image
                        width={image.width}
                        height={image.height}
                        src={post.data.heroImage}
                        alt=""
                        class="mb-3 rounded-xl"
                      />
                    )}
                    <h4 class="title m-0 text-gray-900 leading-tight underline decoration-secondary hover:decoration-primary transition-colors dark:text-gray-100">
                      {post.data.title}
                    </h4>
                    <p class="date m-0 text-gray-400 dark:text-gray-500 text-sm mb-2">
                      <FormattedDate date={post.data.date} />
                      {post.data.updated &&
                        !dayjs(post.data.date).isSame(
                          dayjs(post.data.updated),
                          "day"
                        ) && (
                          <span class="ml-2">
                            Last updated on
                            <FormattedDate date={post.data.updated} />
                          </span>
                        )}
                      {post.data.categories?.map((category) => (
                        <span class="inline-block bg-secondary/20 text-primary text-sm px-2 py-1 rounded mr-2 dark:bg-secondary/30 dark:text-primary/80 ml-2">
                          {category}
                        </span>
                      ))}
                    </p>
                    <ul class="flex gap-1">
                      {post.data.tags?.map((tag) => (
                        <li>
                          <span class="inline-block bg-secondary/20 text-primary text-sm px-2 py-1 rounded mr-2 dark:bg-secondary/30 dark:text-primary/80">
                            {tag}
                          </span>
                        </li>
                      ))}
                    </ul>
                  </a>
                </li>
              );
            })
          }
        </ul>
      </section>
    </main>
    <Footer />
  </body>
</html>
