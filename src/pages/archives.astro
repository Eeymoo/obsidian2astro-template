---
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import Footer from "../components/Footer.astro";
import Header from "../components/Header.astro";
import PostDate from "../components/PostDate.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "../consts";
import { generatePostSlug, filterContent } from "../utils";

const posts = filterContent(await getCollection("blog")).sort(
  (a, b) => b.data.date?.valueOf() - a.data.date?.valueOf()
);

const groupedByYear: Record<string, typeof posts> = {};
for (const post of posts) {
  const year = String(post.data.date.getFullYear());
  if (!groupedByYear[year]) groupedByYear[year] = [];
  groupedByYear[year].push(post);
}
const years = Object.keys(groupedByYear).sort((a, b) => Number(b) - Number(a));
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <BaseHead
      title={`${SITE_TITLE} Â· Archives`}
      description={SITE_DESCRIPTION}
    />
    <script>
      const savedTheme = localStorage.getItem("theme");
      const prefersDark = window.matchMedia(
        "(prefers-color-scheme: dark)"
      ).matches;
      const isDark = savedTheme === "dark" || (!savedTheme && prefersDark);
      if (isDark) {
        document.documentElement.classList.add("dark");
      }
    </script>
  </head>
  <body>
    <Header />
    <main class="w-full max-w-285 mx-auto px-4 py-12">
      <nav class="mb-6 flex gap-4 text-sm">
        <a
          href="/categories"
          class="text-blue-600 dark:text-blue-400 hover:underline">Categories</a
        >
        <a
          href="/tags"
          class="text-blue-600 dark:text-blue-400 hover:underline">Tags</a
        >
      </nav>
      
      <section>
        {
          years.map((year) => (
            <div class="mb-10">
              <h2 class="text-2xl font-semibold text-gray-900 dark:text-gray-100 mb-4">
                {year}
              </h2>
              <ul class="list-none m-0 p-0 space-y-3">
                {groupedByYear[year]
                  .sort(
                    (a, b) => b.data.date?.valueOf() - a.data.date?.valueOf()
                  )
                  .map((post) => {
                    const slug = generatePostSlug(post);
                    return (
                      <li class="w-full">
                        <a
                          href={`/post/${slug}.html`}
                          class="no-style block hover:bg-primary/20 p-4 rounded transition-colors"
                        >
                          <div class="flex items-center gap-3">
                            {post.data.heroImage && (
                              <Image
                                width={160}
                                height={90}
                                src={post.data.heroImage}
                                alt=""
                                class="rounded-lg hidden sm:block"
                              />
                            )}
                            <div class="min-w-0">
                              <h4 class="m-0 text-gray-900 dark:text-gray-100 leading-tight underline decoration-primary hover:decoration-primary transition-colors">
                                {post.data.title}
                              </h4>
                              <PostDate
                                date={post.data.date}
                                updated={post.data.updated}
                                class="m-0"
                              />
                            </div>
                          </div>
                        </a>
                      </li>
                    );
                  })}
              </ul>
            </div>
          ))
        }
      </section>
    </main>
    <Footer />
  </body>
</html>
